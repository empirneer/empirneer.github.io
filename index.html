
<!DOCTYPE html> 
<html> 
    <head> 
        <title>Game</title> 
        <style>
            body {
                margin:0px;
            }
        </style>
    </head> 
    
    <body> 
        <canvas id="myCanvas"></canvas>
    </body> 

    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.min.js"></script> 
    <script> 
        
        var c = document.getElementById("myCanvas");
        var ctx=c.getContext("2d", {alpha: false});
        c.width  = window.innerWidth;
        c.height = window.innerHeight;
        var keys = {};
        window.onkeyup = function(e) { keys[e.keyCode] = false; }
        window.onkeydown = function(e) { keys[e.keyCode] = true; }
        
        var myname = "bird" + Math.round(Math.random()*100000);
        var xpos = Math.round(Math.random()*2000)-1000;
        var ypos = Math.round(Math.random()*2000)-1000;
        
        var playersname = [];
        var playersx = [];
        var playersy = [];
        
        const pubnub = new PubNub({
            publishKey : "pub-c-b2010787-f12b-462f-86c3-63893939f846",
            subscribeKey : "sub-c-1a504e2e-949e-11e9-a293-62d4500be10d"
        }); 
        
        const button = document.getElementById('chat-publish');
        
        pubnub.subscribe({
            channels: ['game']
        }); 
        
        pubnub.publish({
            channel : "game", 
            message : ['create',myname,xpos,ypos]
        }, function(status, response) { 
            //Handle error here 
        });
        
        pubnub.addListener({
            message: function(event) {
                
                if (event.channel == 'game') {
                    if (event.message[0] == 'create' && event.message[1] != myname) {
                        // respond to create
                        pubnub.publish({
                            channel : "game", 
                            message : ["create_response",event.message[1],myname,xpos,ypos]
                        }, function(status, response) { 
                            //Handle error here 
                        });
                        
                        playersname.push(event.message[1]);
                        playersx.push(event.message[2]);
                        playersy.push(event.message[3]);
                    }
                    
                    if (event.message[0] == 'create_response' && event.message[1] == myname) {
                        playersname.push(event.message[2]);
                        playersx.push(event.message[3]);
                        playersy.push(event.message[4]);
                        
                    }
                    
                }
                //let pElement = document.createElement('p'); 
                //pElement.appendChild(document.createTextNode(event.channel+": "+event.message)); 
                //document.getElementById("stream").appendChild(pElement); 
            } 
        }); 
        
        function gx(x_) {return (c.width/2)+(x_/1000*(c.width/2))}
        function gy(y_) {return (c.height/2)+(y_/1000*(c.width/2))}
        function gz(z_) {return (z_/1000*(c.width/2))}
        
        function controls() {
            if (keys["38"]) {ypos+=4} // Up
            if (keys["40"]) {ypos-=4} // Down
            if (keys["37"]) {xpos-=4} // Left
            if (keys["39"]) {xpos+=4} // Right
        }
        
        function drawplayers() {
            // main
            ctx.fillStyle = "blue";
            ctx.fillRect(gx(xpos)-gz(10),gy(ypos)-gz(10),gz(20),gz(20));
            
            // others
            ctx.fillStyle = "red";
            for (var i = 0; i<playersname.length; i++) {
                ctx.fillRect(gx(playersx[i])-gz(10),gy(playersy[i])-gz(10),gz(20),gz(20));
            }
        }
        
        function step() {
            try {
                ctx.clearRect(0,0,c.width,c.height);
                controls();
                drawplayers();
            catch(err) {alert(err)}
            window.requestAnimationFrame(step);
        }
        
        window.requestAnimationFrame(step);

</script> 
</html>
