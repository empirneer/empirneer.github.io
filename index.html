
<!DOCTYPE html> 
<html> 
    <head> 
        <title>empirneer</title> 
        <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE"> 
        <style>
            body {
                margin:0px;
            }
        </style>
    </head> 
    
    <body> 
        <canvas id="myCanvas"></canvas>
    </body> 
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.min.js"></script> 
    <script> 
        
        var c = document.getElementById("myCanvas");
        var ctx=c.getContext("2d", {alpha: true});
        c.width  = window.innerWidth;
        c.height = window.innerHeight;
        var keys = {};
        window.onkeyup = function(e) { keys[e.keyCode] = false; }
        window.onkeydown = function(e) { keys[e.keyCode] = true; }
        
        var myname = "bird" + Math.round(Math.random()*100000);
        var myactive = new Date();
        var xpos = Math.round(Math.random()*2000)-1000;
        var ypos = Math.round(Math.random()*1000)-500;
        
        var playersname = [];
        var playersx = [];
        var playersy = [];
        var playersactive = [];
        var playersdx = []; // display x
        var playersdy = []; // display y
        
        const pubnub = new PubNub({
            publishKey : "pub-c-b2010787-f12b-462f-86c3-63893939f846",
            subscribeKey : "sub-c-1a504e2e-949e-11e9-a293-62d4500be10d"
        }); 
        
        const button = document.getElementById('chat-publish');
        
        pubnub.subscribe({
            channels: ['game']
        }); 
        
        pubnub.publish({
            channel : "game", 
            message : ['create',myname,xpos,ypos]
        }, function(status, response) { 
            //Handle error here 
        });
        
        pubnub.addListener({
            message: function(event) {
                
                if (event.channel == 'game') {
                    
                    // if create
                    
                    if (event.message[0] == 'create' && event.message[1] != myname) {
                        // respond to create
                        pubnub.publish({
                            channel : "game", 
                            message : ["create_response",event.message[1],myname,xpos,ypos]
                        }, function(status, response) { 
                            //Handle error here 
                        });
                        
                        playersname.push(event.message[1]);
                        playersx.push(event.message[2]);
                        playersy.push(event.message[3]);
                        playersdx.push(event.message[2]); // display
                        playersdy.push(event.message[3]);
                        playersactive.push(new Date());
                    }
                    
                    // if creating
                    
                    if (event.message[0] == 'create_response' && event.message[1] == myname) {
                        playersname.push(event.message[2]);
                        playersx.push(event.message[3]);
                        playersy.push(event.message[4]);
                        playersdx.push(event.message[3]); // display
                        playersdy.push(event.message[4]);
                        playersactive.push(new Date());
                        
                    }
                    
                    // movement
                    
                    if (event.message[0] == 'move' && event.message[1] != myname) {
                        try {
                            var indexr = playersname.indexOf(event.message[1]);
                            playersx[indexr] = event.message[2];
                            playersy[indexr] = event.message[3];
                        } catch(err) {
                            // ghost player (still in setup)
                        }
                    }
                    
                    // active player
                    
                    if (event.message[0] == 'active' && event.message[1] != myname) {
                        try {
                            var indexr = playersname.indexOf(event.message[1]);
                            playersactive[indexr] = event.message[2];
                        } catch(err) {
                            // ghost player (still in setup)
                        }
                    }
                    if (event.message[0] == 'active' && event.message[1] == myname) {
                        myactive = new Date()
                    }
                    
                }
            } 
        }); 
        
        function updatepos() {
            pubnub.publish({
                channel : "game", 
                message : ['move',myname,xpos,ypos]
            }, function(status, response) { 
                //Handle error here 
            });
            // send "active" report
            pubnub.publish({
                channel : "game",
                message : ['active',myname, new Date()]
            }, function(status, response) { 
                //Handle error here 
            });
        }
        
        function gx(x_) {return (c.width/2)+(x_/1000*(c.width/2))}
        function gy(y_) {return (c.height/2)-(y_/1000*(c.width/2))}
        function gz(z_) {return (z_/1000*(c.width/2))}
        
        function controls() {
            if (keys["38"]) {ypos+=4} // Up
            if (keys["40"]) {ypos-=4} // Down
            if (keys["37"]) {xpos-=4} // Left
            if (keys["39"]) {xpos+=4} // Right
        }
        
        function drawplayers() {
            // draw strokes
            ctx.lineWidth = gz(6);
            
            ctx.strokeStyle = "red";
            for (var i = 0; i<playersname.length; i++) {
                ctx.beginPath();
                ctx.arc(gx(playersdx[i]), gy(playersdy[i]), gz(40), 0, 2 * Math.PI);
                ctx.closePath();
                ctx.stroke();
            }
            
            ctx.strokeStyle = "blue";
            ctx.beginPath();
            ctx.arc(gx(xpos), gy(ypos), gz(40), 0, 2 * Math.PI);
            ctx.closePath();
            ctx.stroke();
            
            // fill
            ctx.lineWidth = gz(2);
            
            ctx.fillStyle = "black";
            for (var i = 0; i<playersname.length; i++) {
                ctx.beginPath();
                ctx.arc(gx(playersdx[i]), gy(playersdy[i]), gz(40), 0, 2 * Math.PI);
                ctx.closePath();
                ctx.fill();
            }
            
            ctx.beginPath();
            ctx.arc(gx(xpos), gy(ypos), gz(40), 0, 2 * Math.PI);
            ctx.closePath();
            ctx.fill();
        }
        
        function updatedisplay() {
            // movement smoothing
            for (var i = 0;i<playersx.length;i++) {
                
                if (Math.sqrt(((playersdx[i]-playersx[i])*(playersdx[i]-playersx[i])) + ((playersdy[i]-playersy[i])*(playersdy[i]-playersy[i]))) > 60) {
                    // back-glitching
                    playersdx[i] = Math.round(playersdx[i]+((playersx[i]-playersdx[i])/20));
                    playersdy[i] = Math.round(playersdy[i]+((playersy[i]-playersdy[i])/20));
                } 
                else {
                    playersdx[i] = Math.round(playersdx[i]+((playersx[i]-playersdx[i])/5));
                    playersdy[i] = Math.round(playersdy[i]+((playersy[i]-playersdy[i])/5));
                }
            }
        }
        
        function testplayeractive() {
            var thisdate = new Date();
            if (thisdate-myactive > 700) {
                // kick self
            }
            for (var i = 0;i<playersx.length;i++) {
                if (thisdate - playersactive[i] > 700) {
                    // delete
                    playersx.splice(i,1);
                    playersy.splice(i,1);
                    playersdx.splice(i,1);
                    playersdy.splice(i,1);
                    playersactive.splice(i,1);
                    playersname.splice(i,1);
                    i -= 1;
                }
            }
        }
        
        function step() {
            try {
            c.width  = window.innerWidth;
            c.height = window.innerHeight;
            
            ctx.clearRect(0,0,c.width,c.height);
            ctx.fillStyle = "black";
            ctx.fillRect(0,0,c.width,c.height);
            controls();
            updatedisplay();
            drawplayers();
            testplayeractive()
            } catch(err) {alert(err)}
            
            window.requestAnimationFrame(step);
        }
        
        window.setInterval(updatepos, 100);
        window.requestAnimationFrame(step);

    </script> 
</html>
